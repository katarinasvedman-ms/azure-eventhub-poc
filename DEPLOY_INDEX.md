# ğŸš€ EventHub PoC - Complete Deployment Guide

## ğŸ“‹ Quick Navigation

### ğŸ¯ Start Here
- **[BICEP_SETUP.md](BICEP_SETUP.md)** â† START HERE for Bicep deployment
- **[DEPLOYMENT_QUICKSTART.md](DEPLOYMENT_QUICKSTART.md)** - 3-step quick start
- **[SKU_RECOMMENDATION.md](SKU_RECOMMENDATION.md)** - Sizing & tier selection

### ğŸ—ï¸ Infrastructure
- **deploy/main.bicep** - Bicep infrastructure template
- **deploy/parameters.dev.json** - Parameter file
- **deploy/deploy.ps1** - PowerShell deployment script
- **deploy/deploy.sh** - Bash deployment script
- **deploy/README.md** - Detailed deployment docs

### ğŸ“š Documentation
- **[ARCHITECTURE.md](ARCHITECTURE.md)** - System architecture & design patterns
- **[BEST_PRACTICES_ANALYSIS.md](BEST_PRACTICES_ANALYSIS.md)** - 12 best practices with examples
- **[DEPLOYMENT.md](DEPLOYMENT.md)** - Docker & local deployment
- **[README.md](README.md)** - Project overview

### ğŸ’» Application Code
- **src/Program.cs** - ASP.NET Core setup & DI
- **src/Services/** - Event Hub & batching services
- **src/Controllers/** - REST API endpoints
- **docker-compose.yml** - Local development environment

### ğŸ§ª Testing
- **load-test.js** - K6 load testing script (20k evt/sec)

---

## âš¡ 5-Minute Deployment

```powershell
# 1. Authenticate
az login
az account set --subscription "your-subscription-id"

# 2. Deploy
cd deploy
.\deploy.ps1 -ResourceGroupName "rg-logsysng-dev" -Location "eastus"

# 3. Configure
# Copy connection strings from appsettings.generated.json to appsettings.json

# 4. Run
cd ..
dotnet run --configuration Release
```

---

## ğŸ“Š Infrastructure Overview

```
Azure Event Hub (Standard SKU)
â”œâ”€â”€ Namespace: eventhub-dev-xxx
â”œâ”€â”€ Hub: logs (24 partitions)
â”œâ”€â”€ Consumer Groups:
â”‚   â”œâ”€â”€ logs-consumer
â”‚   â”œâ”€â”€ monitoring-consumer
â”‚   â””â”€â”€ archive-consumer
â”œâ”€â”€ Storage Account (Checkpoints)
â”‚   â””â”€â”€ Container: checkpoints
â””â”€â”€ Authorization Policies:
    â”œâ”€â”€ SendPolicy (Producer)
    â””â”€â”€ ListenPolicy (Consumer)

Capacity: 20,000 events/sec @ 1 KB
Cost: ~$75-100/month
```

---

## ğŸ¯ Key Specifications

| Aspect | Value | Notes |
|---|---|---|
| **SKU Tier** | Standard | Supports 32 partitions, 32k evt/sec |
| **Partitions** | 24 | 20 required + 4 headroom |
| **Event Size** | 1 KB avg | Max 1 MB per event |
| **Throughput** | 20 MB/s | 1 MB/s per partition limit |
| **Retention** | 1 day | Configurable up to 90 days |
| **Consumer Groups** | 20 | 3 created: logs, monitoring, archive |
| **Checkpoint Storage** | Blob Storage | Prevents data loss & duplicate processing |

---

## ğŸš€ Deployment Artifacts

### Files Created by Bicep
1. **Event Hub Namespace** - Container for hubs
2. **Event Hub (logs)** - Message topic with 24 partitions
3. **Consumer Groups** - For independent event processing
4. **Storage Account** - For checkpoint state
5. **Blob Container** - Stores consumer group offsets

### Files Generated by Script
- `appsettings.generated.json` - Contains all connection strings

---

## ğŸ”Œ Connection Information

After deployment, you'll receive:

```json
{
  "EventHub": {
    "Namespace": "eventhub-dev-xxx.servicebus.windows.net",
    "HubName": "logs",
    "ProducerConnectionString": "Endpoint=sb://...;SharedAccessKeyName=SendPolicy;...",
    "ConsumerConnectionString": "Endpoint=sb://...;SharedAccessKeyName=ListenPolicy;..."
  },
  "Storage": {
    "AccountName": "sablobcheckpointxxx",
    "ConnectionString": "DefaultEndpointsProtocol=https;...",
    "Container": "checkpoints"
  }
}
```

---

## ğŸ“ˆ Scaling Timeline

| Phase | Events/Sec | Partitions | SKU | Timeline | Notes |
|---|---|---|---|---|---|
| **Phase 1 (Now)** | 20,000 | 24 | Standard | Start | No upgrade needed |
| **Phase 2** | 40,000 | 40 | Premium | Year 2 | Exceeds Standard |
| **Phase 3** | 100,000+ | 100+ | Premium/Dedicated | Year 3+ | Enterprise scale |

---

## âœ… Post-Deployment Verification

```powershell
# 1. Check resource group
az group show --name "rg-logsysng-dev" --output table

# 2. List Event Hub namespace
az eventhubs namespace list --resource-group "rg-logsysng-dev" --output table

# 3. View Event Hub details
az eventhubs eventhub show \
  --namespace-name "eventhub-dev-xxx" \
  --resource-group "rg-logsysng-dev" \
  --name "logs" \
  --output table

# 4. List consumer groups
az eventhubs eventhub consumer-group list \
  --namespace-name "eventhub-dev-xxx" \
  --resource-group "rg-logsysng-dev" \
  --eventhub-name "logs" \
  --output table

# 5. Check storage account
az storage account show \
  --name "sablobcheckpointxxx" \
  --resource-group "rg-logsysng-dev" \
  --output table
```

---

## ğŸ”„ Deployment Methods

### Method 1: PowerShell Script (Recommended)
- Validates prerequisites
- Creates resource group
- Generates configuration automatically
- âœ… **Best for Windows users**

```powershell
.\deploy.ps1 -ResourceGroupName "rg-logsysng-dev"
```

### Method 2: Bash Script
- Same features as PowerShell
- âœ… **Best for Linux/Mac users**

```bash
./deploy.sh -g "rg-logsysng-dev"
```

### Method 3: Azure CLI Manual
- Full control
- âœ… **Best for CI/CD integration**

```powershell
az deployment group create \
  --resource-group "rg-logsysng-dev" \
  --template-file main.bicep \
  --parameters parameters.dev.json
```

### Method 4: Azure Portal
- GUI-based
- âœ… **Best for learning**

1. Search "Template deployment" in portal
2. "Build your own template"
3. Paste main.bicep contents

---

## ğŸ“Š Cost Estimation

### Monthly Breakdown (US East)
| Item | Quantity | Unit Cost | Total |
|---|---|---|---|
| Event Hub Namespace | 1 | $50 | $50 |
| Ingestion | 20k evt/sec | Included | - |
| Storage | 1 GB | $0.50 | $0.50 |
| Transactions | Variable | $0.44/M | ~$1-5 |
| **Monthly Total** | - | - | **~$75-100** |

### Annual Cost
- Year 1 (Standard tier): ~$900-1,200
- Year 2 (Premium upgrade): ~$5,000-6,000
- Year 3+ (Premium): ~$5,000-6,000

*Regional variation: Premium pricing varies; use Azure Cost Calculator for exact figures*

---

## ğŸ› ï¸ Customization Guide

### Change Partitions
Edit `parameters.dev.json`:
```json
{
  "parameters": {
    "partitionCount": { "value": 32 }
  }
}
```

### Change Retention
```json
{
  "parameters": {
    "messageRetentionInDays": { "value": 7 }
  }
}
```

### Change Region
```json
{
  "parameters": {
    "location": { "value": "westus2" }
  }
}
```

### Upgrade to Premium (Later)
Edit `deploy/main.bicep` - Change SKU section:
```bicep
sku: {
  name: 'Premium'
  tier: 'Premium'
  capacity: 1
}
```

---

## ğŸš¨ Troubleshooting

| Issue | Cause | Solution |
|---|---|---|
| "Namespace already exists" | Global name collision | Auto-generation recommended |
| "Cannot connect" | Wrong connection string | Use from appsettings.generated.json |
| "Throttling (429 errors)" | Exceeding throughput | Increase partitions or SKU |
| "Storage not found" | Wrong account name | Verify in appsettings.json |
| "Checkpoint failed" | Container missing | Verify "checkpoints" container exists |

See [deploy/README.md](deploy/README.md) for detailed troubleshooting.

---

## ğŸ“š Documentation Map

```
Root Level
â”œâ”€â”€ BICEP_SETUP.md ..................... Overview & setup guide
â”œâ”€â”€ DEPLOYMENT_QUICKSTART.md .......... 3-step quick start
â”œâ”€â”€ SKU_RECOMMENDATION.md ............. Sizing & tier selection
â”œâ”€â”€ ARCHITECTURE.md ................... System design & patterns
â”œâ”€â”€ BEST_PRACTICES_ANALYSIS.md ........ 12 best practices deep-dive
â”œâ”€â”€ DEPLOYMENT.md ..................... Docker & local deployment
â”œâ”€â”€ README.md ......................... Project overview

deploy/ (Bicep Infrastructure)
â”œâ”€â”€ main.bicep ........................ Infrastructure template
â”œâ”€â”€ parameters.dev.json .............. Parameter file
â”œâ”€â”€ deploy.ps1 ....................... PowerShell deployment
â”œâ”€â”€ deploy.sh ......................... Bash deployment
â”œâ”€â”€ README.md ......................... Deployment guide
â”œâ”€â”€ VARIABLES.md ..................... Parameter reference
â””â”€â”€ appsettings.generated.json ....... Auto-generated (after deploy)

src/ (Application Code)
â”œâ”€â”€ Program.cs ....................... ASP.NET Core setup
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ EventHubProducerService.cs ... Producer with batching
â”‚   â”œâ”€â”€ EventHubConsumerService.cs ... Consumer with checkpoints
â”‚   â””â”€â”€ EventBatchingService.cs ...... Batching logic
â”œâ”€â”€ Controllers/
â”‚   â””â”€â”€ LogsController.cs ............ REST endpoints
â””â”€â”€ Models/ .......................... Event models

Tests & Load Testing
â””â”€â”€ load-test.js ..................... K6 load test script
```

---

## ğŸ¯ Success Criteria

After deployment, verify:

âœ… Resource group created in Azure  
âœ… Event Hub namespace operational  
âœ… 24 partitions visible  
âœ… 3 consumer groups created  
âœ… Storage account with checkpoints container  
âœ… SendPolicy & ListenPolicy authorized  
âœ… Application connects without errors  
âœ… Metrics visible in Azure Portal  

---

## ğŸ”— Important Links

- **[Azure Event Hub Documentation](https://learn.microsoft.com/azure/event-hubs/)**
- **[Event Hub Quotas & Limits](https://learn.microsoft.com/azure/event-hubs/event-hubs-quotas)**
- **[Bicep Documentation](https://learn.microsoft.com/azure/azure-resource-manager/bicep/)**
- **[Azure CLI Reference](https://learn.microsoft.com/cli/azure/)**
- **[Azure Cost Calculator](https://azure.microsoft.com/pricing/calculator/)**
- **[K6 Load Testing](https://k6.io/)**

---

## ğŸ“ Support

### For Deployment Issues
See `deploy/README.md` troubleshooting section

### For Architecture Questions
See `ARCHITECTURE.md`

### For Best Practices
See `BEST_PRACTICES_ANALYSIS.md`

### For Sizing
See `SKU_RECOMMENDATION.md`

---

## ğŸ“ Learning Path

1. **Read**: [SKU_RECOMMENDATION.md](SKU_RECOMMENDATION.md) - Understand sizing
2. **Read**: [ARCHITECTURE.md](ARCHITECTURE.md) - Understand design
3. **Read**: [BEST_PRACTICES_ANALYSIS.md](BEST_PRACTICES_ANALYSIS.md) - Learn patterns
4. **Deploy**: [BICEP_SETUP.md](BICEP_SETUP.md) - Infrastructure
5. **Run**: [DEPLOYMENT.md](DEPLOYMENT.md) - Application
6. **Test**: `load-test.js` - Load testing

---

**Status**: âœ… Complete & Ready for Production  
**Target Throughput**: 20,000 events/sec  
**Infrastructure**: Azure Event Hub Standard Tier  
**Deployment Tool**: Bicep (IaC)  
**Last Updated**: December 16, 2025

---

## ğŸš€ Ready to Deploy?

**Start here**: [BICEP_SETUP.md](BICEP_SETUP.md)
